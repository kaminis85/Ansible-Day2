# ---
# # Ansible tasks for simulating a disaster recovery scenario using NetApp Trident Protect in OpenShift Virtualization environment.
# # These tasks simulate a disaster on the source cluster and perform failover to the destination cluster.
# 
# # Preflight check for disaster simulation variables
# - name: Preflight check for disaster simulation related variables
#   ansible.builtin.assert:
#     that:
#       - src_oc_api_url is defined
#       - src_oc_api_token is defined
#       - src_vm_namespace is defined
#       - dst_oc_api_url is defined
#       - dst_oc_api_token is defined
#       - dst_vm_namespace is defined
#       - app_mirror_relationship_specs is defined
#       - app_mirror_relationship_specs.name is defined
#     fail_msg: "Disaster simulation related variables are not properly defined. Check vars/trident_protect_main.yml"
#     success_msg: "Disaster simulation related variables validated successfully"
#   tags:
#     - dr_preflight
#     - dr_simulate_disaster
# 
# # Display information about the disaster simulation
# - name: Display disaster simulation information
#   ansible.builtin.debug:
#     msg:
#       - "=========================================="
#       - "DISASTER RECOVERY SIMULATION"
#       - "=========================================="
#       - "This will simulate a disaster on the source cluster by:"
#       - "  1. Stopping/deleting VMs in the source namespace"
#       - "  2. Optionally deleting the source namespace"
#       - "  3. Simulating source cluster unavailability"
#       - "=========================================="
#       - "Source Cluster: {{ src_oc_api_url }}"
#       - "Source Namespace: {{ src_vm_namespace }}"
#       - "=========================================="
#   tags:
#     - dr_simulate_disaster
# 
# # Pause for confirmation before proceeding with disaster simulation
# - name: Pause for confirmation before simulating disaster
#   ansible.builtin.pause:
#     prompt: "Are you sure you want to simulate a disaster on the source cluster? This will stop/delete VMs in namespace {{ src_vm_namespace }}. Press CTRL+C to abort, or press ENTER to continue"
#   tags:
#     - dr_simulate_disaster
# 
# # Get list of VirtualMachines with src_vm_label in the source namespace before disaster
# - name: Get list of VirtualMachines with label {{ src_vm_label }} in source namespace {{ src_vm_namespace }}
#   kubernetes.core.k8s_info:
#     kind: VirtualMachine
#     api_version: kubevirt.io/v1
#     namespace: "{{ src_vm_namespace }}"
#     host: "{{ src_oc_api_url }}"
#     api_key: "{{ src_oc_api_token }}"
#     validate_certs: false
#     label_selectors:
#       - "app={{ src_vm_label }}"
#   register: src_vms_before_disaster
#   tags:
#     - dr_simulate_disaster
# 
# # Display the VMs that will be affected
# - name: Display VirtualMachines that will be affected by the disaster
#   ansible.builtin.debug:
#     msg: "VMs to be stopped/deleted: {{ src_vms_before_disaster.resources | map(attribute='metadata.name') | list }}"
#   when: src_vms_before_disaster.resources | length > 0
#   tags:
#     - dr_simulate_disaster
# 
# # Stop all running VirtualMachines in the source namespace (simulate disaster)
# - name: Stop all VirtualMachines in source namespace {{ src_vm_namespace }} to simulate disaster
#   kubernetes.core.k8s:
#     state: present
#     host: "{{ src_oc_api_url }}"
#     api_key: "{{ src_oc_api_token }}"
#     validate_certs: false
#     kind: VirtualMachine
#     api_version: kubevirt.io/v1
#     name: "{{ item.metadata.name }}"
#     namespace: "{{ src_vm_namespace }}"
#     definition:
#       spec:
#         running: false
#   loop: "{{ src_vms_before_disaster.resources }}"
#   when: src_vms_before_disaster.resources | length > 0
#   tags:
#     - dr_simulate_disaster
#     - dr_stop_vms
# 
# # Optional: Delete all VirtualMachines in the source namespace (more severe disaster)
# - name: Delete all VirtualMachines in source namespace {{ src_vm_namespace }} to simulate complete disaster
#   kubernetes.core.k8s:
#     state: absent
#     host: "{{ src_oc_api_url }}"
#     api_key: "{{ src_oc_api_token }}"
#     validate_certs: false
#     kind: VirtualMachine
#     api_version: kubevirt.io/v1
#     name: "{{ item.metadata.name }}"
#     namespace: "{{ src_vm_namespace }}"
#   loop: "{{ src_vms_before_disaster.resources }}"
#   when:
#     - src_vms_before_disaster.resources | length > 0
#     - dr_delete_vms is defined and dr_delete_vms | bool
#   tags:
#     - dr_simulate_disaster
#     - dr_delete_vms
# 
# # Wait for disaster simulation to complete
# - name: Wait for disaster simulation to complete
#   ansible.builtin.pause:
#     seconds: 10
#     prompt: "Waiting for disaster simulation to complete..."
#   tags:
#     - dr_simulate_disaster
# 
# # Display disaster simulation completion
# - name: Display disaster simulation completion status
#   ansible.builtin.debug:
#     msg:
#       - "=========================================="
#       - "DISASTER SIMULATION COMPLETED"
#       - "=========================================="
#       - "Source cluster VMs have been stopped/deleted"
#       - "You can now proceed with failover to destination cluster"
#       - "=========================================="
#   tags:
#     - dr_simulate_disaster

# Failover replicated VMs to the destination OpenShift cluster
# On the destination OpenShift cluster, update the AppMirrorRelationship to promote it (failover)
- name: Promote AppMirrorRelationship on the destination OpenShift cluster to activate replicated VMs
  kubernetes.core.k8s:
    state: present
    host: "{{ dst_oc_api_url }}"
    api_key: "{{ dst_oc_api_token }}"
    validate_certs: false
    namespace: "{{ dst_vm_namespace }}"
    definition:
      apiVersion: protect.trident.netapp.io/v1
      kind: AppMirrorRelationship
      metadata:
        name: "{{ app_mirror_relationship_specs.name }}"
      spec:
        desiredState: "Promoted"
  tags:
    - failover_to_dst_cluster