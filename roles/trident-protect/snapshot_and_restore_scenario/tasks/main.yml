---
# Ansible tasks to demonstrate Snapshot and Restore Scenario for VMs in OpenShift Virtualization using Trident protect
# Note: This playbook assumes that Trident and Trident protect are already installed and configured in your OpenShift cluster and that the common tasks in roles/trident-protect/trident-protect-common have been executed to configure the prerequisites like AppVault and Application.
# Note: Make sure to run the tasks in roles/trident-protect/create_snapshot_schedule first to create the snapshot schedule before running the restore tasks here.
# Note: Ensure that the snapshot schedule has created at least one snapshot before running the restore tasks here.

# View the snapshots created by the snapshot schedule
- name: Get snapshots created by the snapshot schedule in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: protect.trident.netapp.io/v1
    kind: Snapshot
    namespace: "{{ vm_namespace | default('') }}"
  register: snapshots_output
  when: vm_namespace is defined and vm_namespace != ""
  tags:
    - tp_view_snapshots
    - tp_create_snapshotinplacerestore

- name: Filter snapshots for the application {{ application_name | default('') }}
  ansible.builtin.set_fact:
    filtered_snapshots: "{{ snapshots_output.resources | selectattr('spec.applicationRef', 'defined') | selectattr('spec.applicationRef', 'equalto', application_name) | list }}"
  when:
    - application_name is defined and application_name != ""
    - snapshots_output is defined
    - snapshots_output.resources is defined
  tags:
    - tp_view_snapshots
    - tp_create_snapshotinplacerestore

- name: Display snapshots created for the application {{ application_name | default('') }} in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    msg: "{{ filtered_snapshots | map(attribute='metadata.name') | list }}"
  when:
    - vm_namespace is defined and vm_namespace != ""
    - application_name is defined and application_name != ""
    - filtered_snapshots is defined and filtered_snapshots | length > 0
  tags:
    - tp_view_snapshots
    - tp_create_snapshotinplacerestore

- name: Display message if no snapshots found
  ansible.builtin.debug:
    msg: "No snapshots found for application {{ application_name | default('') }} in {{ vm_namespace | default('') }} namespace"
  when:
    - vm_namespace is defined and vm_namespace != ""
    - application_name is defined and application_name != ""
    - filtered_snapshots is defined and filtered_snapshots | length == 0
  tags:
    - tp_view_snapshots
    - tp_create_snapshotinplacerestore

# If your VMs have been corrupted or accidentally deleted, you can restore them to the original namespace using the snapshot created by the snapshot schedule.
# Note: Ensure that the VMs and their associated resources are deleted from the original namespace before running the restore tasks here.
# Users can choose to delete the VMs and their associated resources manually to simulate corruption or accidental deletion. For manual deletion, you can use the commands below:
# oc delete vm <vm-name> -n <vm-namespace>
# oc delete pvc <pvc-name> -n <vm-namespace>
# Repeat the above commands for all VMs and their associated PVCs listed in the vm_list and pvc_list variables respectively under vars/trident_protect_main.yml

# OR you can use the below tasks to automate the deletion of VMs and their associated resources.
- name: Delete specific VMs in {{ vm_namespace | default('') }} namespace to simulate corruption or accidental deletion
  kubernetes.core.k8s:
    state: absent
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: kubevirt.io/v1
    namespace: "{{ vm_namespace | default('') }}"
    kind: VirtualMachine
    name: "{{ item }}"
  loop: "{{ vm_list }}"
  when:
    - vm_namespace is defined and vm_namespace != ""
    - vm_list is defined and vm_list | length > 0
  tags:
    - tp_delete_vms_and_pvcs
    - tp_create_snapshotinplacerestore

- name: Delete specific PVCs in {{ vm_namespace | default('') }} namespace to simulate corruption or accidental deletion
  kubernetes.core.k8s:
    state: absent
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: v1
    namespace: "{{ vm_namespace | default('') }}"
    kind: PersistentVolumeClaim
    name: "{{ item }}"
  loop: "{{ pvc_list }}"
  when:
    - vm_namespace is defined and vm_namespace != ""
    - pvc_list is defined and pvc_list | length > 0
  tags:
    - tp_delete_vms_and_pvcs
    - tp_create_snapshotinplacerestore

# Verify that the VMs and their associated resources have been deleted from the original namespace
- name: Verify that the VMs have been deleted from {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    namespace: "{{ vm_namespace | default('') }}"
    label_selectors:
      - "category={{ vm_label | default('') }}"
  register: vm_deletion_check
  when:
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - tp_verify_vms_and_pvcs_deletion
    - tp_create_snapshotinplacerestore

- name: Verify that the PVCs have been deleted from {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "{{ vm_namespace | default('') }}"
    label_selectors:
      - "category={{ vm_label | default('') }}"
  register: pvc_deletion_check
  when:
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - tp_verify_vms_and_pvcs_deletion
    - tp_create_snapshotinplacerestore

- name: Display message if no VMs and PVCs with label '{{ vm_label | default('') }}' found in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    msg: "No VMs and PVCs with label '{{ vm_label | default('') }}' found in {{ vm_namespace | default('') }} namespace. Proceeding with restoration."
  when: 
    - vm_deletion_check is defined
    - vm_deletion_check.resources is defined
    - pvc_deletion_check is defined
    - pvc_deletion_check.resources is defined
    - vm_deletion_check.resources | length == 0
    - pvc_deletion_check.resources | length == 0
  tags:
    - tp_verify_vms_and_pvcs_deletion
    - tp_create_snapshotinplacerestore

- name: Display message if VMs or PVCs with label '{{ vm_label | default('') }}' still exist in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    msg: "Deletion verification failed! Found {{ vm_deletion_check.resources | length }} VM(s) and {{ pvc_deletion_check.resources | length }} PVC(s) with label '{{ vm_label | default('') }}' still remaining in {{ vm_namespace | default('') }} namespace. Please delete them before proceeding with restoration."
  when:
    - vm_deletion_check is defined
    - vm_deletion_check.resources is defined
    - pvc_deletion_check is defined
    - pvc_deletion_check.resources is defined
    - (vm_deletion_check.resources | length > 0) or (pvc_deletion_check.resources | length > 0)
  failed_when:
    - vm_deletion_check is defined
    - vm_deletion_check.resources is defined
    - pvc_deletion_check is defined
    - pvc_deletion_check.resources is defined
    - (vm_deletion_check.resources | length > 0) or (pvc_deletion_check.resources | length > 0)
  tags:
    - tp_verify_vms_and_pvcs_deletion
    - tp_create_snapshotinplacerestore

# Get the latest snapshot for restoration
- name: Get the latest snapshot for application {{ application_name | default('') }} in {{ vm_namespace | default('') }} namespace
  ansible.builtin.set_fact:
    latest_snapshot: "{{ filtered_snapshots | sort(attribute='metadata.creationTimestamp', reverse=true) | first }}"
  when:
    - filtered_snapshots is defined
    - filtered_snapshots | length > 0
  tags:
    - tp_create_snapshotinplacerestore

- name: Display the snapshot that will be used for restoration
  ansible.builtin.debug:
    msg: "Using snapshot '{{ latest_snapshot.metadata.name }}' with appArchivePath '{{ latest_snapshot.status.appArchivePath }}' for restoration"
  when:
    - filtered_snapshots is defined and filtered_snapshots | length > 0
    - latest_snapshot is defined
  tags:
    - tp_create_snapshotinplacerestore

# Verify that the snapshot has volume snapshots (not empty)
- name: Check if the snapshot has volume snapshots
  ansible.builtin.set_fact:
    snapshot_has_volumes: "{{ latest_snapshot.status.volumeSnapshots is defined and latest_snapshot.status.volumeSnapshots | length > 0 }}"
  when:
    - filtered_snapshots is defined and filtered_snapshots | length > 0
    - latest_snapshot is defined
  tags:
    - tp_create_snapshotinplacerestore

- name: Display snapshot volume snapshot count
  ansible.builtin.debug:
    msg: "Snapshot '{{ latest_snapshot.metadata.name }}' contains {{ latest_snapshot.status.volumeSnapshots | default([]) | length }} volume snapshot(s)"
  when:
    - filtered_snapshots is defined and filtered_snapshots | length > 0
    - latest_snapshot is defined
  tags:
    - tp_create_snapshotinplacerestore

- name: Fail if snapshot is empty (no volume snapshots)
  ansible.builtin.fail:
    msg: "Cannot proceed with restoration! Snapshot '{{ latest_snapshot.metadata.name }}' is empty (no volume snapshots found). This means no VMs with label '{{ vm_label | default('') }}' existed when the snapshot was taken. Please ensure VMs have the correct labels and wait for a new snapshot to be created."
  when: 
    - filtered_snapshots is defined and filtered_snapshots | length > 0
    - latest_snapshot is defined
    - snapshot_has_volumes is defined
    - not snapshot_has_volumes
  tags:
    - tp_create_snapshotinplacerestore

# Create a SnapshotInplaceRestore object to restore VMs to the original namespace using the latest snapshot's appArchivePath
- name: Create a SnapshotInplaceRestore object to restore VMs to {{ vm_namespace | default('') }} namespace using appArchivePath
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: "{{ vm_namespace | default('') }}"
    definition:
      apiVersion: protect.trident.netapp.io/v1
      kind: SnapshotInplaceRestore
      metadata:
        name: "{{ snapshotinplacerestore_name | default('') }}"  # Name of the SnapshotInplaceRestore object used for restoration
      spec:
        appVaultRef: "{{ appvault_name | default('') }}"
        appArchivePath: "{{ latest_snapshot.status.appArchivePath }}"
  when: 
    - snapshot_has_volumes is defined
    - snapshot_has_volumes
    - vm_namespace is defined and vm_namespace != ""
    - snapshotinplacerestore_name is defined and snapshotinplacerestore_name != ""
    - appvault_name is defined and appvault_name != ""
  tags:
    - tp_create_snapshotinplacerestore

# Wait for the restore to complete
- name: Wait for the restore to complete
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: protect.trident.netapp.io/v1
    namespace: "{{ vm_namespace | default('') }}"
    kind: SnapshotInplaceRestore
    name: "{{ snapshotinplacerestore_name | default('') }}"
  register: snapshotinplacerestore_info
  until: >
    snapshotinplacerestore_info.resources | length > 0 and
    snapshotinplacerestore_info.resources[0].status is defined and
    snapshotinplacerestore_info.resources[0].status.state is defined and
    snapshotinplacerestore_info.resources[0].status.state == "Completed"
  retries: 30
  delay: 30
  when:
    - vm_namespace is defined and vm_namespace != ""
    - snapshotinplacerestore_name is defined and snapshotinplacerestore_name != ""
  tags:
    - tp_wait_for_snapshotinplacerestore_completion

# Verify that the SnapshotInplaceRestore object was created successfully
- name: Get SnapshotInplaceRestore objects in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: protect.trident.netapp.io/v1
    kind: SnapshotInplaceRestore
    namespace: "{{ vm_namespace | default('') }}"
  register: snapshotinplacerestore_output
  when: vm_namespace is defined and vm_namespace != ""
  tags:
    - tp_verify_snapshotinplacerestore

- name: Display SnapshotInplaceRestore details for {{ snapshotinplacerestore_name | default('') }}
  ansible.builtin.debug:
    msg: 
      - "Name: {{ item.metadata.name }}"
      - "State: {{ item.status.state | default('N/A') }}"
      - "AppVault: {{ item.spec.appVaultRef }}"
      - "AppArchivePath: {{ item.spec.appArchivePath }}"
      - "Creation Time: {{ item.metadata.creationTimestamp }}"
  loop: "{{ snapshotinplacerestore_output.resources }}"
  when:
    - snapshotinplacerestore_output is defined
    - snapshotinplacerestore_output.resources | length > 0
  tags:
    - tp_verify_snapshotinplacerestore

# Note: After the restore is complete, you can verify that the VMs and their associated resources have been restored to the original namespace by checking the status of the VMs and their PVCs using the commands below:
# oc get vm -n <vm-namespace>
# oc get pvc -n <vm-namespace>
# Repeat the above commands for all VMs and their associated PVCs listed in the vm_list and pvc_list variables respectively under vars/trident_protect_main.yml

# Verify that the VMs and their associated resources have been restored to the original namespace
- name: Verify that the VMs have been restored to {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    namespace: "{{ vm_namespace | default('') }}"
    label_selectors:
      - "category={{ vm_label | default('') }}"
  register: restored_vms_info
  when:
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - tp_verify_snapshotinplacerestore_vms
    - tp_verify_snapshotinplacerestore_all

- name: Verify that the PVCs have been restored to {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "{{ vm_namespace | default('') }}"
    label_selectors:
      - "category={{ vm_label | default('') }}"
  register: restored_pvcs_info
  when:
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - tp_verify_snapshotinplacerestore_pvcs
    - tp_verify_snapshotinplacerestore_all

- name: Display restored VMs in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    msg: "Restored VM: {{ item }}"
  loop: "{{ restored_vms_info.resources | map(attribute='metadata.name') | list }}"
  when:
    - restored_vms_info is defined
    - restored_vms_info.resources is defined
    - restored_vms_info.resources | length > 0
  tags:
    - tp_verify_snapshotinplacerestore_vms
    - tp_verify_snapshotinplacerestore_all

- name: Display restored PVCs in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    msg: "Restored PVC: {{ item }}"
  loop: "{{ restored_pvcs_info.resources | map(attribute='metadata.name') | list }}"
  when:
    - restored_pvcs_info is defined
    - restored_pvcs_info.resources is defined
    - restored_pvcs_info.resources | length > 0
  tags:
    - tp_verify_snapshotinplacerestore_pvcs
    - tp_verify_snapshotinplacerestore_all

- name: Display summary of restored resources
  ansible.builtin.debug:
    msg:
      - "Restoration Summary:"
      - "Total VMs restored: {{ restored_vms_info.resources | length }}"
      - "Total PVCs restored: {{ restored_pvcs_info.resources | length }}"
  when:
    - restored_vms_info is defined
    - restored_vms_info.resources is defined
    - restored_pvcs_info is defined
    - restored_pvcs_info.resources is defined
  tags:
    - tp_verify_snapshotinplacerestore_all

# End of Snapshot and Restore Scenario tasks