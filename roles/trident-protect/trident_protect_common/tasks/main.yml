---
# Trident protect common tasks for both Backup/Restore and Snapshot/Restore scenarios

# Verify Trident Protect installation
- name: Check if trident-protect namespace exists
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    kind: Namespace
    name: trident-protect
  register: tp_namespace_check
  failed_when: tp_namespace_check.resources | length == 0
  tags:
    - tp_prerequisites

- name: Verify Trident Protect is installed (check controller manager deployment)
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    kind: Deployment
    namespace: trident-protect
    name: trident-protect-controller-manager
  register: tp_deployment_check
  failed_when: tp_deployment_check.resources | length == 0
  tags:
    - tp_prerequisites

# Create Kubernetes Secret to store ONTAP S3 credentials
- name: Create Kubernetes Secret to store ONTAP S3 credentials
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: trident-protect   # Must be in the Trident protect namespace
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: "{{ appvault_secret_name | default('') }}"   # Name of your secret
      type: Opaque
      stringData:
        accessKeyID: "{{ s3_access_key | default('') }}"
        secretAccessKey: "{{ s3_secret_key | default('') }}"
  when:
    - appvault_secret_name is defined and appvault_secret_name != ""
    - s3_access_key is defined and s3_access_key != ""
    - s3_secret_key is defined and s3_secret_key != ""
  tags:
    - s3_secret_create

# Verify the newly created Secret in Trident protect namespace
- name: Verify ONTAP S3 Secret creation in trident-protect namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    kind: Secret
    namespace: trident-protect
    name: "{{ appvault_secret_name | default('') }}"
  register: s3_secret_output
  when: appvault_secret_name is defined and appvault_secret_name != ""
  tags:
    - s3_secret_verify

- name: Display ONTAP S3 Secret details
  ansible.builtin.debug:
    var: s3_secret_output.resources[0]
  when: 
    - s3_secret_output.resources is defined
    - s3_secret_output.resources | length > 0
  tags:
    - s3_secret_verify

# Create Trident protect AppVault for ONTAP S3
- name: Create Trident protect AppVault for ONTAP S3
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: trident-protect   # Must be in the Trident protect namespace
    definition:
      apiVersion: protect.trident.netapp.io/v1
      kind: AppVault
      metadata:
        name: "{{ appvault_name | default('') }}"   # Name of your AppVault
      spec:
        providerType: "OntapS3"
        providerConfig:
          s3:
            bucketName: "{{ ontap_s3_bucket_name | default('') }}"
            endpoint: "{{ ontap_s3_endpoint | default('') }}"
            secure: "false"
            skipCertValidation: "true"
        providerCredentials:
          accessKeyID:
            valueFromSecret:
              name: "{{ appvault_secret_name | default('') }}"   # Name of the S3 secret created earlier
              key: accessKeyID
          secretAccessKey:
            valueFromSecret:
              name: "{{ appvault_secret_name | default('') }}"
              key: secretAccessKey
  when: 
    - appvault_name is defined and appvault_name != ""
    - ontap_s3_bucket_name is defined and ontap_s3_bucket_name != ""
    - ontap_s3_endpoint is defined and ontap_s3_endpoint != ""
    - appvault_secret_name is defined and appvault_secret_name != ""
  tags:
    - tp_create_appvault

# Verify the newly created AppVault in Trident protect namespace
- name: Verify AppVault creation in trident-protect namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    kind: AppVault
    api_version: protect.trident.netapp.io/v1
    namespace: trident-protect
    name: "{{ appvault_name | default('') }}"
  register: appvault_output
  when: appvault_name is defined and appvault_name != ""
  tags:
    - tp_verify_appvault

- name: Display AppVault details
  ansible.builtin.debug:
    var: appvault_output.resources[0]
  when:
    - appvault_output.resources is defined
    - appvault_output.resources | length > 0
  tags:
    - tp_verify_appvault

# Check if VM namespace exists before labeling
- name: Check if {{ vm_namespace | default('') }} namespace exists
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    kind: Namespace
    name: "{{ vm_namespace | default('') }}"
  register: vm_namespace_check
  failed_when: vm_namespace_check.resources | length == 0
  when: vm_namespace is defined and vm_namespace != ""
  tags:
    - oc_verify_vm_namespace
    - oc_label_vms_and_pvcs

# Label VMs in a namespace
- name: Label VMs in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: "{{ vm_namespace | default('') }}"
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    name: "{{ item }}"
    merge_type: merge
    definition:
      metadata:
        labels:
          category: "{{ vm_label | default('') }}"
  loop: "{{ vm_list | default([]) }}"
  when: 
    - vm_list is defined and vm_list | length > 0
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - oc_label_vms_and_pvcs
    - oc_label_vms

# Label PVCs associated with VMs in a namespace
- name: Label PVCs in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: "{{ vm_namespace | default('') }}"
    api_version: v1
    kind: PersistentVolumeClaim
    name: "{{ item }}"
    merge_type: strategic-merge
    definition:
      metadata:
        labels:
          category: "{{ vm_label | default('') }}"
  loop: "{{ pvc_list | default([]) }}"
  when: 
    - pvc_list is defined and pvc_list | length > 0
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - oc_label_vms_and_pvcs
    - oc_label_pvcs

# Verify that the VMs got the labels
- name: Verify labels for VMs in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: kubevirt.io/v1
    kind: VirtualMachine
    namespace: "{{ vm_namespace | default('') }}"
    name: "{{ item }}"
  loop: "{{ vm_list | default([]) }}"
  register: vm_label_info
  when: 
    - vm_list is defined and vm_list | length > 0
    - vm_namespace is defined and vm_namespace != ""
  tags:
    - oc_verify_vms_and_pvcs_labels
    - oc_verify_vm_labels

# Verify that the PVCs got the labels
- name: Verify labels for PVCs in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: v1
    kind: PersistentVolumeClaim
    namespace: "{{ vm_namespace | default('') }}"
    name: "{{ item }}"
  loop: "{{ pvc_list | default([]) }}"
  register: pvc_label_info
  when: 
    - pvc_list is defined and pvc_list | length > 0
    - vm_namespace is defined and vm_namespace != ""
  tags:
    - oc_verify_vms_and_pvcs_labels
    - oc_verify_pvc_labels

- name: Display label information for VMs
  ansible.builtin.debug:
    msg: "{{ item.resources[0].metadata.labels | default({}) }}"
  loop: "{{ vm_label_info.results | default([]) }}"
  when: 
    - vm_label_info is defined
    - item.resources is defined
    - item.resources | length > 0
  tags:
    - oc_verify_vms_and_pvcs_labels
    - oc_verify_vm_labels

- name: Display label information for PVCs
  ansible.builtin.debug:
    msg: "{{ item.resources[0].metadata.labels | default({}) }}"
  loop: "{{ pvc_label_info.results | default([]) }}"
  when: 
    - pvc_label_info is defined
    - item.resources is defined
    - item.resources | length > 0
  tags:
    - oc_verify_vms_and_pvcs_labels
    - oc_verify_pvc_labels

# Create an application for specific VMs using the label selector
- name: Create an application in {{ vm_namespace | default('') }} namespace for specific VMs using the label selector
  kubernetes.core.k8s:
    state: present
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    namespace: "{{ vm_namespace | default('') }}"
    definition:
      apiVersion: protect.trident.netapp.io/v1
      kind: Application
      metadata:
        name: "{{ application_name | default('') }}"   # Application name for the VMs
      spec:
        includedNamespaces:
          - namespace: "{{ vm_namespace | default('') }}"
            labelSelector:
              matchLabels:
                category: "{{ vm_label | default('') }}"
  when: 
    - application_name is defined and application_name != ""
    - vm_namespace is defined and vm_namespace != ""
    - vm_label is defined and vm_label != ""
  tags:
    - tp_create_application

# Verify the newly created application in the specified namespace
- name: Verify Application creation in {{ vm_namespace | default('') }} namespace
  kubernetes.core.k8s_info:
    host: "{{ oc_api_url }}"
    api_key: "{{ oc_api_token }}"
    validate_certs: false
    api_version: protect.trident.netapp.io/v1
    kind: Application
    namespace: "{{ vm_namespace | default('') }}"
    name: "{{ application_name | default('') }}"
  register: application_output
  when: 
    - application_name is defined and application_name != ""
    - vm_namespace is defined and vm_namespace != ""
  tags:
    - tp_verify_application

- name: Display Application details created in {{ vm_namespace | default('') }} namespace
  ansible.builtin.debug:
    var: application_output.resources[0]
  when: 
    - application_output.resources is defined
    - application_output.resources | length > 0
  tags:
    - tp_verify_application

# End of Trident protect common tasks