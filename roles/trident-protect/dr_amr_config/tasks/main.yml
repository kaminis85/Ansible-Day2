---
# Ansible tasks for creating and configuring AppMirrorRelationship (AMR) for VM replication from source to destination OpenShift cluster.
# This role should be executed AFTER the dr_amr_prerequisites role has been run and snapshots are available on the source cluster.
# For scheduled snapshots, ensure the schedule has created at least one snapshot before running this role.

# Prerequisites check - Verify that snapshots exist on the source cluster before proceeding with AMR creation
- name: Check for available snapshots for application {{ src_application_name }} in source namespace {{ src_vm_namespace }}
  kubernetes.core.k8s_info:
    kind: Snapshot
    api_version: protect.trident.netapp.io/v1
    namespace: "{{ src_vm_namespace }}"
    host: "{{ src_oc_api_url }}"
    api_key: "{{ src_oc_api_token }}"
    validate_certs: false
  register: src_snapshots_all
  changed_when: false
  tags:
    - amr_preflight
    - amr_verify_snapshots

- name: Filter snapshots for source application {{ src_application_name }}
  ansible.builtin.set_fact:
    src_snapshots_check:
      resources: "{{ src_snapshots_all.resources | selectattr('spec.applicationRef', 'defined') | selectattr('spec.applicationRef', 'equalto', src_application_name) | list }}"
  when:
    - src_snapshots_all is defined
    - src_snapshots_all.resources is defined
  tags:
    - amr_preflight
    - amr_verify_snapshots

- name: Verify at least one snapshot exists for application {{ src_application_name }} before creating AMR
  ansible.builtin.assert:
    that:
      - src_snapshots_check.resources | length > 0
    fail_msg: "No snapshots found for application '{{ src_application_name }}' in namespace {{ src_vm_namespace }}. Ensure snapshots are created before proceeding with AMR configuration."
    success_msg: "Found {{ src_snapshots_check.resources | length }} snapshot(s) for application '{{ src_application_name }}' in namespace {{ src_vm_namespace }}. Proceeding with AMR configuration."
  when:
    - src_snapshots_check is defined
    - src_snapshots_check.resources is defined
  tags:
    - amr_preflight
    - amr_verify_snapshots

- name: Display snapshot details for verification
  ansible.builtin.debug:
    msg: "Snapshot: {{ item.metadata.name }} | State: {{ item.status.state | default('Unknown') }} | Created: {{ item.metadata.creationTimestamp | default('Unknown') }} | Completed: {{ item.status.completionTimestamp | default('In Progress') }} | AppVault: {{ item.status.appVaultRef | default('Unknown') }}"
  loop: "{{ src_snapshots_check.resources }}"
  when:
    - src_snapshots_check is defined
    - src_snapshots_check.resources is defined
    - src_snapshots_check.resources | length > 0
  tags:
    - amr_preflight
    - amr_verify_snapshots

# Preflight validation - Validate variables for AppMirrorRelationship (AMR) configuration on the destination cluster
- name: Validate variables for AppMirrorRelationship (AMR) configuration on the destination cluster
  ansible.builtin.assert:
    that:
      - appmirrorrelationship_specs is defined
      - appmirrorrelationship_specs is mapping
      - appmirrorrelationship_specs.name is defined and appmirrorrelationship_specs.name | default('') | trim | length > 0
      - appmirrorrelationship_specs.storage_class is defined and appmirrorrelationship_specs.storage_class | default('') | trim | length > 0
      - appmirrorrelationship_specs.recurrence_rule is defined and appmirrorrelationship_specs.recurrence_rule is mapping
      - appmirrorrelationship_specs.recurrence_rule.dtstart is defined and appmirrorrelationship_specs.recurrence_rule.dtstart | default('') | trim | length > 0
      - appmirrorrelationship_specs.recurrence_rule.rrule is defined and appmirrorrelationship_specs.recurrence_rule.rrule | default('') | trim | length > 0
    fail_msg: "Variables for AppMirrorRelationship configuration are not properly defined. Check vars/trident_protect_main.yml"
    success_msg: "Variables for AppMirrorRelationship configuration validated successfully"
  tags:
    - amr_preflight
    - dst_appmirrorrelationship_create

# Fetch the source application UID from the source OpenShift cluster
- name: Get source application UID from the source OpenShift cluster
  kubernetes.core.k8s_info:
    kind: Application
    api_version: protect.trident.netapp.io/v1
    name: "{{ src_application_name }}"
    namespace: "{{ src_vm_namespace }}"
    host: "{{ src_oc_api_url }}"
    api_key: "{{ src_oc_api_token }}"
    validate_certs: false
  register: src_application_info
  changed_when: false
  failed_when: src_application_info.resources | length == 0
  tags:
    - amr_preflight
    - dst_appmirrorrelationship_create

# Extract the source application UID
- name: Set source application UID as fact for AMR creation
  ansible.builtin.set_fact:
    src_application_uid: "{{ src_application_info.resources[0].metadata.uid }}"
  tags:
    - amr_preflight
    - dst_appmirrorrelationship_create

# Validate that snapshot verification was completed successfully
- name: Ensure snapshot verification was performed before AMR creation
  ansible.builtin.assert:
    that:
      - src_snapshots_check is defined
      - src_snapshots_check.resources is defined
    fail_msg: "Snapshot verification was not completed. Cannot proceed with AMR creation without validating snapshots exist."
    success_msg: "Snapshot verification completed successfully"
  tags:
    - amr_preflight
    - dst_appmirrorrelationship_create

# On the destination OpenShift cluster, create an AppMirrorRelationship CR to replicate VMs from source to destination
- name: Create an AppMirrorRelationship CR on destination OpenShift cluster to replicate VMs from source to destination
  kubernetes.core.k8s:
    state: present
    host: "{{ dst_oc_api_url }}"
    api_key: "{{ dst_oc_api_token }}"
    validate_certs: false
    wait: false
    definition:
      apiVersion: protect.trident.netapp.io/v1
      kind: AppMirrorRelationship
      metadata:
        name: "{{ appmirrorrelationship_specs.name }}"
        namespace: "{{ dst_vm_namespace }}"
      spec:
        desiredState: "Established"
        destinationAppVaultRef: "{{ dst_appvault_name }}"
        sourceAppVaultRef: "{{ src_appvault_name }}"
        sourceApplicationName: "{{ src_application_name }}"
        sourceApplicationUID: "{{ src_application_uid }}"
        storageClassName: "{{ appmirrorrelationship_specs.storage_class }}"
        namespaceMapping:
          - destination: "{{ dst_vm_namespace }}"
            source: "{{ src_vm_namespace }}"
        recurrenceRule: |-
          DTSTART:{{ appmirrorrelationship_specs.recurrence_rule.dtstart }}
          RRULE:{{ appmirrorrelationship_specs.recurrence_rule.rrule }}
  tags:
    - dst_appmirrorrelationship_create

# View the AppMirrorRelationship details on the destination OpenShift cluster
- name: Get AppMirrorRelationship details to verify creation on the destination OpenShift cluster
  kubernetes.core.k8s_info:
    kind: AppMirrorRelationship
    api_version: protect.trident.netapp.io/v1
    name: "{{ appmirrorrelationship_specs.name }}"
    namespace: "{{ dst_vm_namespace }}"
    host: "{{ dst_oc_api_url }}"
    api_key: "{{ dst_oc_api_token }}"
    validate_certs: false
  register: dst_appmirrorrelationship_info
  changed_when: false
  failed_when: dst_appmirrorrelationship_info.resources | length == 0
  tags:
    - dst_appmirrorrelationship_verify

# Display the AppMirrorRelationship details created on the destination OpenShift cluster
- name: Display AppMirrorRelationship information created in {{ dst_vm_namespace }} namespace on the destination OpenShift cluster
  ansible.builtin.debug:
    var: dst_appmirrorrelationship_info.resources[0]
  tags:
    - dst_appmirrorrelationship_verify

# Wait for the AppMirrorRelationship to reach the Established state
- name: Wait for AppMirrorRelationship {{ appmirrorrelationship_specs.name }} to reach Established state
  kubernetes.core.k8s_info:
    kind: AppMirrorRelationship
    api_version: protect.trident.netapp.io/v1
    name: "{{ appmirrorrelationship_specs.name }}"
    namespace: "{{ dst_vm_namespace }}"
    host: "{{ dst_oc_api_url }}"
    api_key: "{{ dst_oc_api_token }}"
    validate_certs: false
  register: dst_amr_state
  until: >
    dst_amr_state.resources | length > 0 and
    dst_amr_state.resources[0].status.state is defined and
    dst_amr_state.resources[0].status.state == "Established"
  retries: 60
  delay: 30
  changed_when: false
  tags:
    - dst_appmirrorrelationship_verify
    - dst_appmirrorrelationship_wait_established

# Display the AppMirrorRelationship state after establishment
- name: Display AppMirrorRelationship state after reaching Established
  ansible.builtin.debug:
    msg: "AppMirrorRelationship '{{ appmirrorrelationship_specs.name }}' is now in '{{ dst_amr_state.resources[0].status.state }}' state"
  when: dst_amr_state.resources | length > 0 and dst_amr_state.resources[0].status.state is defined
  tags:
    - dst_appmirrorrelationship_verify
    - dst_appmirrorrelationship_wait_established