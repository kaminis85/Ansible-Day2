---
# Ansible task to refresh OpenShift cluster token by logging in using provided credentials.
# The oc login command automatically generates/updates the kubeconfig file
- name: Login to OpenShift cluster and refresh token
  ansible.builtin.command:
    cmd: oc login --username={{ oc_username }} --password={{ oc_password }} --server={{ oc_api_url }}
  environment:
    KUBECONFIG: "{{ oc_kubeconfig_path }}"
  register: oc_login_result
  changed_when: "'Login successful' in oc_login_result.stdout"
  failed_when: "'error' in oc_login_result.stderr | lower or oc_login_result.rc != 0"
  no_log: true
  tags:
    - refresh_oc_token

- name: Set proper permissions on kubeconfig file
  ansible.builtin.file:
    path: "{{ oc_kubeconfig_path }}"
    state: file
    mode: '0600'
  tags:
    - refresh_oc_token